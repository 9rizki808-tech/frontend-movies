<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cinema Tickets ‚Ä¢ Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Booking Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(114, 9, 183, 0.4);
      position: relative;
    }

    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 28px;
      font-weight: bold;
      color: var(--disney-purple);
      cursor: pointer;
    }

    .booking-step {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cinema Seat Layout */
    .cinema-screen {
      text-align: center;
      padding: 15px;
      background: var(--disney-purple);
      color: white;
      margin-bottom: 25px;
      border-radius: 10px;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .cinema-seats {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      margin: 20px 0;
    }

    .seat {
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 10px;
      transition: all 0.2s;
    }

    .seat.available {
      background: var(--disney-light-blue);
      color: var(--disney-purple);
    }

    .seat.available:hover {
      background: var(--disney-yellow);
      transform: scale(1.1);
    }

    .seat.selected {
      background: var(--disney-pink);
      color: white;
    }

    .seat.occupied {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    .seat-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      font-size: 12px;
    }

    .booking-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="dashboard-header">
    <nav class="navbar">
      <a href="#" class="logo">CINEMA TICKETS</a>
      <div class="header-actions">
        <button class="btn btn-add" onclick="showMovieForm()">
          <span>+</span> Add Movie
        </button>
        <button class="btn btn-logout" onclick="logout()">Logout</button>
      </div>
    </nav>
  </header>

  <!-- Movie Form -->
  <div class="movie-form" id="movieForm">
    <h2 id="formTitle">Add New Movie</h2>
    <form id="movieFormContent">
      <div class="form-grid">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" placeholder="Movie title" required>
        </div>
        <div class="form-group">
          <label for="director">Director *</label>
          <input type="text" id="director" placeholder="Director name" required>
        </div>
        <div class="form-group">
          <label for="genre">Genre *</label>
          <input type="text" id="genre" placeholder="Action, Drama, etc." required>
        </div>
        <div class="form-group">
          <label for="duration">Duration (minutes) *</label>
          <input type="number" id="duration" min="1" placeholder="120" required>
        </div>
        <div class="form-group">
          <label for="rating">Rating (0.0 - 10.0)</label>
          <input type="number" id="rating" min="0" max="10" step="0.1" placeholder="8.5">
        </div>
        <div class="form-group">
          <label for="release_date">Release Date *</label>
          <input type="date" id="release_date" required>
        </div>
        <div class="form-group full-width">
          <label for="poster_url">Poster URL</label>
          <input type="url" id="poster_url" placeholder="https://example.com/poster.jpg">
        </div>
        <div class="form-group full-width">
          <label for="synopsis">Synopsis *</label>
          <textarea id="synopsis" placeholder="Movie synopsis..." rows="4" required></textarea>
        </div>
      </div>
      <button type="submit" class="btn">Save Movie</button>
      <button type="button" class="btn" style="background:#666;" onclick="hideMovieForm()">Cancel</button>
    </form>
  </div>

  <!-- Booking Modal -->
  <div id="bookingModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeBookingModal()">&times;</span>
      <h2>üéüÔ∏è Book Tickets</h2>
      
      <div id="bookingStep1" class="booking-step">
        <h3>Select Show Time</h3>
        <input type="hidden" id="bookingMovieId">
        <input type="hidden" id="bookingMovieTitle">
        
        <div class="form-group">
          <label for="showDate">Date</label>
          <input type="date" id="showDate" min="" required>
        </div>
        
        <div class="form-group">
          <label for="showTime">Time</label>
          <select id="showTime" required>
            <option value="">Select time</option>
            <option value="13:00">13:00</option>
            <option value="16:00">16:00</option>
            <option value="19:00">19:00</option>
            <option value="21:30">21:30</option>
          </select>
        </div>
        
        <button type="button" class="btn" onclick="nextToSeats()">Next: Choose Seats</button>
      </div>

      <div id="bookingStep2" class="booking-step" style="display:none;">
        <h3>Select Your Seats</h3>
        <p id="selectedSeatsInfo">No seats selected</p>
        
        <!-- Cinema Seat Layout -->
        <div class="cinema-screen">SCREEN</div>
        <div class="cinema-seats" id="cinemaSeats">
          <!-- Seats will be generated by JS -->
        </div>
        
        <div class="seat-legend">
          <div><span class="seat available"></span> Available</div>
          <div><span class="seat selected"></span> Selected</div>
          <div><span class="seat occupied"></span> Occupied</div>
        </div>
        
        <div class="booking-actions">
          <button type="button" class="btn" style="background:#6c757d;" onclick="backToTime()">Back</button>
          <button type="button" class="btn" onclick="confirmBooking()">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bookings Section -->
  <div class="booking-card">
    <div class="booking-header">üéüÔ∏è Your Bookings</div>
    <div id="bookingsList">
      <!-- Bookings will be loaded here -->
    </div>
  </div>

  <!-- Movies List -->
  <section class="movies-section">
    <h2 class="section-title">Your Movie Collection</h2>
    <div class="movies-grid" id="moviesGrid">
      <!-- Movies will be loaded here -->
    </div>
  </section>

  <script src="js/main.js"></script>
  <script>
    let currentEditId = null;
    let selectedSeats = [];
    const PRICE_PER_SEAT = 50000; // Rp 50.000 per seat

    // Set minimum date to today
    if (document.getElementById('showDate')) {
      document.getElementById('showDate').min = new Date().toISOString().split('T')[0];
    }

    // Check authentication
    if (!getToken()) {
      window.location.href = 'login.html';
    }

    // Load data
    async function loadData() {
      await loadMovies();
      await loadBookings();
    }

    // Load movies
    async function loadMovies() {
      try {
        const movies = await getMovies();
        const grid = document.getElementById('moviesGrid');
        
        if (movies.length === 0) {
          grid.innerHTML = '<div class="empty-state"><h3>No movies yet</h3><p>Add your first movie to start selling tickets!</p></div>';
          return;
        }
        
        grid.innerHTML = movies.map(movie => `
          <div class="movie-card">
            <img src="${movie.poster_url || 'https://via.placeholder.com/200x240/a9def9/7209b7?text=Movie+Poster'}" 
                 alt="${movie.title}" class="movie-poster">
            <div class="movie-overlay">
              <div class="movie-title">${movie.title}</div>
              <div class="movie-meta">${movie.release_date} ‚Ä¢ ${movie.duration}m</div>
            </div>
            <div style="padding: 10px; display:flex;gap:5px;">
              <button onclick="editMovie(${movie.id})" class="action-btn edit-btn">‚úèÔ∏è Edit</button>
              <button onclick="deleteMovieConfirm(${movie.id})" class="action-btn delete-btn">üóëÔ∏è Delete</button>
              <button onclick="openBookingModal(${movie.id}, '${movie.title.replace(/'/g, "\\'")}')"
                      class="action-btn book-btn">üé´ Book</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('moviesGrid').innerHTML = '<div class="empty-state"><h3>Failed to load movies</h3></div>';
      }
    }

    // Load bookings
    async function loadBookings() {
      try {
        const bookings = await getBookings();
        const container = document.getElementById('bookingsList');
        
        if (bookings.length === 0) {
          container.innerHTML = '<p style="color:#7209b7; text-align:center;">No bookings yet. Start selling tickets!</p>';
          return;
        }
        
        container.innerHTML = bookings.map(booking => `
          <div class="booking-info">
            <div class="info-row">
              <span class="info-label">Movie:</span>
              <span class="info-value">${booking.movie_title}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Date & Time:</span>
              <span class="info-value">${formatDate(booking.show_date)} at ${formatTime(booking.show_time)}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Seats:</span>
              <span class="info-value">${booking.seats}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Total:</span>
              <span class="info-value">${formatCurrency(booking.total_price)}</span>
            </div>
            <div class="booking-code">${booking.booking_code}</div>
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('bookingsList').innerHTML = '<p style="color:#f72585; text-align:center;">Failed to load bookings</p>';
      }
    }

    // BOOKING FUNCTIONS
    function openBookingModal(movieId, movieTitle) {
      document.getElementById('bookingMovieId').value = movieId;
      document.getElementById('bookingMovieTitle').value = movieTitle;
      document.getElementById('bookingStep1').style.display = 'block';
      document.getElementById('bookingStep2').style.display = 'none';
      selectedSeats = [];
      document.getElementById('bookingModal').style.display = 'flex';
      
      // Set minimum date again (in case page was open for a while)
      document.getElementById('showDate').min = new Date().toISOString().split('T')[0];
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').style.display = 'none';
    }

    function nextToSeats() {
      const date = document.getElementById('showDate').value;
      const time = document.getElementById('showTime').value;
      
      if (!date || !time) {
        alert('Please select date and time');
        return;
      }
      
      // Generate seat layout (simulasi 10x8 seats)
      generateSeatLayout();
      document.getElementById('bookingStep1').style.display = 'none';
      document.getElementById('bookingStep2').style.display = 'block';
    }

    function backToTime() {
      document.getElementById('bookingStep2').style.display = 'none';
      document.getElementById('bookingStep1').style.display = 'block';
    }

    function generateSeatLayout() {
      const seatsContainer = document.getElementById('cinemaSeats');
      seatsContainer.innerHTML = '';
      selectedSeats = [];
      updateSelectedSeatsInfo();
      
      // Create 8 rows (A-H), 10 seats per row (1-10)
      const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
      for (let row of rows) {
        for (let col = 1; col <= 10; col++) {
          const seat = document.createElement('div');
          seat.className = 'seat available';
          seat.textContent = `${row}${col}`;
          seat.onclick = () => toggleSeat(`${row}${col}`);
          seatsContainer.appendChild(seat);
        }
      }
      
      // Simulate some occupied seats (random)
      const seats = seatsContainer.querySelectorAll('.seat');
      seats.forEach((seat, index) => {
        if (Math.random() < 0.2) { // 20% occupied
          seat.className = 'seat occupied';
          seat.onclick = null;
        }
      });
    }

    function toggleSeat(seatId) {
      const seatElement = Array.from(document.querySelectorAll('.seat')).find(s => s.textContent === seatId);
      if (!seatElement || seatElement.classList.contains('occupied')) return;
      
      const index = selectedSeats.indexOf(seatId);
      if (index > -1) {
        selectedSeats.splice(index, 1);
        seatElement.classList.remove('selected');
        seatElement.classList.add('available');
      } else {
        selectedSeats.push(seatId);
        seatElement.classList.remove('available');
        seatElement.classList.add('selected');
      }
      
      updateSelectedSeatsInfo();
    }

    function updateSelectedSeatsInfo() {
      const info = document.getElementById('selectedSeatsInfo');
      if (selectedSeats.length === 0) {
        info.textContent = 'No seats selected';
        info.style.color = '#f72585';
      } else {
        info.innerHTML = `Selected: <strong>${selectedSeats.join(', ')}</strong> | Total: <strong>${formatCurrency(selectedSeats.length * PRICE_PER_SEAT)}</strong>`;
        info.style.color = '#7209b7';
      }
    }

    async function confirmBooking() {
      if (selectedSeats.length === 0) {
        alert('Please select at least one seat');
        return;
      }
      
      const movieId = document.getElementById('bookingMovieId').value;
      const showDate = document.getElementById('showDate').value;
      const showTime = document.getElementById('showTime').value;
      const seats = selectedSeats.join(',');
      const totalPrice = selectedSeats.length * PRICE_PER_SEAT;
      
      try {
        await createBooking({
          movie_id: movieId,
          show_date: showDate,
          show_time: showTime,
          seats: seats,
          total_price: totalPrice
        });
        
        alert('üéâ Booking successful! Your tickets are confirmed.');
        closeBookingModal();
        loadData();
      } catch (error) {
        alert('Failed to create booking: ' + error.message);
      }
    }

    // Form functions (same as before)
    function showMovieForm() {
      document.getElementById('formTitle').textContent = 'Add New Movie';
      document.getElementById('movieForm').style.display = 'block';
      resetForm();
      currentEditId = null;
    }

    function hideMovieForm() {
      document.getElementById('movieForm').style.display = 'none';
    }

    function resetForm() {
      document.getElementById('title').value = '';
      document.getElementById('director').value = '';
      document.getElementById('genre').value = '';
      document.getElementById('duration').value = '';
      document.getElementById('rating').value = '';
      document.getElementById('release_date').value = '';
      document.getElementById('poster_url').value = '';
      document.getElementById('synopsis').value = '';
    }

    function editMovie(id) {
      currentEditId = id;
      document.getElementById('formTitle').textContent = 'Edit Movie';
      document.getElementById('movieForm').style.display = 'block';
      // In production, you'd populate the form with existing data
    }

    async function deleteMovieConfirm(id) {
      if (confirm('Are you sure you want to delete this movie? This will also delete all related bookings.')) {
        try {
          await deleteMovie(id);
          loadData();
        } catch (error) {
          alert('Failed to delete movie: ' + error.message);
        }
      }
    }

    // Form submission
    document.getElementById('movieFormContent').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const movieData = {
        title: document.getElementById('title').value,
        director: document.getElementById('director').value,
        genre: document.getElementById('genre').value,
        duration: parseInt(document.getElementById('duration').value),
        rating: document.getElementById('rating').value ? parseFloat(document.getElementById('rating').value) : null,
        release_date: document.getElementById('release_date').value,
        poster_url: document.getElementById('poster_url').value || null,
        synopsis: document.getElementById('synopsis').value
      };
      
      try {
        if (currentEditId) {
          await updateMovie(currentEditId, movieData);
        } else {
          await createMovie(movieData);
        }
        hideMovieForm();
        loadData();
      } catch (error) {
        alert('Error saving movie: ' + error.message);
      }
    });

    // Logout
    function logout() {
      clearAuth();
      window.location.href = 'login.html';
    }

    // Initialize
    loadData();
  </script>
</body>
</html>